<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quest 2: Lindungi Pohonku dari Hama!</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
  
  :root {
    --primary: #31710f;
    --primary-light: #4caf50;
    --primary-dark: #2e4a27;
    --accent: #ffb300;
    --light-bg: #eaf6e1;
    --danger: #e53935;
    --success: #43a047;
    --warning: #ffa000;
  }
  
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100vw;
    font-family: 'Poppins', sans-serif;
    color: var(--primary-dark);
    user-select: none;
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    background-image: url('../assets/Background/TunarunguBG.jpg');
    overflow: hidden;
    box-sizing: border-box;
  }
  
  body {
    min-height: 100vh;
    min-width: 100vw;
    width: 100vw;
    height: 100vh;
    position: relative;
    overflow: hidden !important;
  }
  
  #mainWrapper {
    width: 100vw;
    height: 100vh;
    min-height: 100vh;
    min-width: 100vw;
    overflow: hidden;
    position: relative;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: stretch;
  }
  
  h1 {
    font-weight: 700;
    font-size: 2.2rem;
    margin: 12px 0 6px;
    color: var(--primary);
    text-align: center;
    z-index: 2;
    position: relative;
    text-shadow: 0 2px 4px rgba(255, 255, 255, 0.8);
    background-image: linear-gradient(135deg, var(--primary), #4e9e22);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  /* Overlays */
  .overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    backdrop-filter: blur(5px);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 150;
    text-align: center;
    padding: 20px;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
    transition: opacity 0.4s ease, visibility 0.4s;
  }
  
  #introOverlay {
    background: linear-gradient(rgba(220, 237, 193, 0.9), rgba(212, 232, 177, 0.95));
  }
  
  #introOverlay h2 {
    font-size: 2.5rem;
    margin-bottom: 16px;
    color: var(--primary);
    font-weight: 700;
    animation: fadeInDown 1.2s ease forwards;
    text-shadow: 0 2px 5px rgba(255, 255, 255, 0.8);
  }
  
  #introOverlay p {
    font-size: 1.3rem;
    margin-bottom: 28px;
    max-width: 550px;
    color: var(--primary-dark);
    line-height: 1.4;
    animation: fadeInUp 1.2s ease forwards;
  }
  
  .primary-button {
    background: linear-gradient(to bottom right, var(--primary-light), var(--primary));
    border: none;
    color: white;
    font-weight: 700;
    font-size: 18px;
    padding: 14px 36px;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 8px 15px rgba(46, 125, 50, 0.4);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .primary-button::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s;
  }
  
  .primary-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(46, 125, 50, 0.5);
  }
  
  .primary-button:hover::after {
    opacity: 1;
  }
  
  .primary-button:active {
    transform: translateY(1px);
    box-shadow: 0 5px 10px rgba(46, 125, 50, 0.4);
  }
  
  #howToPlayOverlay {
    display: none;
    background: rgba(220, 237, 193, 0.9);
  }
  
  #howToPlayOverlay .howto-content {
    max-width: 650px;
    margin: 0 auto;
    background: #fff;
    border-radius: 24px;
    padding: 36px 36px 32px 36px;
    box-shadow: 0 12px 40px rgba(178, 214, 166, 0.6);
    animation: fadeInScale 0.5s ease-out;
  }
  
  #howToPlayOverlay h2 {
    margin-top: 0;
    color: var(--primary);
    font-size: 1.6rem;
    margin-bottom: 20px;
  }
  
  #howToPlayOverlay ol {
    padding-left: 20px;
    margin-bottom: 20px;
    font-size: 1.1rem;
    line-height: 1.5;
    text-align: left;
  }
  
  #howToPlayOverlay .howto-tips {
    margin: 16px 0;
    font-size: 1rem;
    background: var(--light-bg);
    padding: 12px 20px;
    border-radius: 12px;
    text-align: left;
    border-left: 4px solid var(--primary);
  }
  
  #gameContainer {
    width: 100vw;
    height: 100vh;
    min-height: 100vh;
    min-width: 100vw;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    position: relative;
    padding: 0;
    visibility: hidden;
    cursor: default;
    overflow: hidden;
    transition: visibility 0.4s ease;
  }
  
  #gameContainer.active {
    visibility: visible;
  }
  
  #header {
    display: flex;
    justify-content: space-between;
    font-size: 1.3rem;
    font-weight: 600;
    margin: 12px 20px;
    color: var(--primary);
    z-index: 2;
  }
  
  #treeArea {
    position: relative;
    flex: 1;
    overflow: visible;
    min-height: 360px;
    max-height: 520px;
    height: 480px;
    width: 100vw;
    margin: 0 auto;
    z-index: 1;
  }
  
  #tree {
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    filter: drop-shadow(0 4px 5px rgba(0,0,0,0.2));
    user-select: none;
    pointer-events: none;
    transition: width 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.5s ease;
    z-index: 5;
  }
  
  #tree.stage-1 { width: 120px; }
  #tree.stage-2 { width: 160px; }
  #tree.stage-3 { width: 200px; filter: drop-shadow(0 6px 8px rgba(0,0,0,0.25)); }
  #tree.stage-4 { width: 240px; filter: drop-shadow(0 8px 10px rgba(0,0,0,0.3)); }
  
  /* Background elements for more immersion */
  #groundLayer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 60px;
    background: linear-gradient(to bottom, #8bc34a, #5d8731);
    z-index: 1;
    border-top: 4px solid #6a9939;
  }
  
  #soilLayer {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 30px;
    background: linear-gradient(to bottom, #795548, #5d4037);
    z-index: 2;
  }
  
  #grassElements {
    position: absolute;
    bottom: 30px;
    left: 0;
    width: 100%;
    height: 20px;
    background-image: 
      linear-gradient(to top, transparent 0%, transparent 50%, #74c13d 50%, #74c13d 60%, transparent 60%) 0 0 / 10px 20px,
      linear-gradient(to top, transparent 0%, transparent 45%, #74c13d 45%, #74c13d 55%, transparent 55%) 5px 0 / 10px 20px,
      linear-gradient(to top, transparent 0%, transparent 40%, #5fad29 40%, #5fad29 55%, transparent 55%) 10px 0 / 10px 20px,
      linear-gradient(to top, transparent 0%, transparent 55%, #74c13d 55%, #74c13d 75%, transparent 75%) 15px 0 / 10px 20px,
      linear-gradient(to top, transparent 0%, transparent 50%, #5fad29 50%, #5fad29 65%, transparent 65%) 20px 0 / 10px 20px;
    background-repeat: repeat-x;
    z-index: 3;
  }
  
  #bugArea {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    overflow: visible;
    width: 100vw;
    height: 100%;
    z-index: 10;
  }
  
  .bug {
    position: absolute;
    font-size: 36px;
    user-select: none;
    cursor: pointer;
    pointer-events: auto;
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55), 
                opacity 0.3s ease, 
                filter 0.3s ease;
    filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3));
    display: flex;
    flex-direction: column;
    align-items: center;
    white-space: nowrap;
    z-index: 15;
  }
  
  .bug:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 2px 5px rgba(0,0,0,0.4));
  }
  
  .bug.slow-motion {
    transition-duration: 2s !important;
    filter: drop-shadow(0 0 8px rgba(255, 165, 0, 0.7));
  }
  
  .bug-label {
    margin-top: 4px;
    font-size: 13px;
    background: rgba(255, 255, 255, 0.9);
    padding: 3px 8px;
    border-radius: 12px;
    color: var(--primary-dark);
    font-weight: 600;
    text-align: center;
    max-width: 150px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    opacity: 0;
    transform: translateY(-5px);
    transition: opacity 0.3s, transform 0.3s;
  }
  
  .bug:hover .bug-label {
    opacity: 1;
    transform: translateY(0);
  }
  
  #toolsPanel {
    margin: 40px auto 15px auto;
    display: flex;
    justify-content: center;
    gap: 25px;
    user-select: none;
    z-index: 30;
    background: rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(5px);
    border-radius: 20px;
    padding: 15px 25px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    max-width: 650px;
  }
  
  .tool {
    width: 70px;
    height: 70px;
    border-radius: 18px;
    background: linear-gradient(to bottom right, #c3e6b3, #9edd89);
    box-shadow: 0 5px 15px rgba(123, 185, 103, 0.4);
    font-size: 40px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    justify-content: center;
    align-items: center;
    user-select: none;
    border: 3px solid transparent;
    position: relative;
  }
  
  .tool::after {
    content: attr(title);
    position: absolute;
    bottom: -30px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 14px;
    background: rgba(255,255,255,0.9);
    color: var(--primary-dark);
    padding: 3px 10px;
    border-radius: 12px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s, transform 0.3s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    pointer-events: none;
  }
  
  .tool:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  
  .tool:hover {
    transform: translateY(-5px) scale(1.1);
    border-color: var(--primary-light);
    box-shadow: 0 8px 20px rgba(76, 175, 80, 0.5);
  }
  
  .tool.active {
    border-color: var(--primary);
    background: linear-gradient(to bottom right, #a8e6cf, #74c13d);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(46, 125, 50, 0.5);
  }
  
  #avatarPakBurung {
    position: absolute;
    bottom: 10px;
    left: 20px;
    width: 100px;
    height: 100px;
    background: linear-gradient(to bottom right, #5cbb5e, #3d8c3d);
    border-radius: 50%;
    box-shadow: 0 8px 25px rgba(42, 107, 21, 0.5);
    font-size: 60px;
    text-align: center;
    line-height: 100px;
    filter: drop-shadow(0 0 5px rgba(33, 100, 19, 0.8));
    user-select: none;
    pointer-events: none;
    z-index: 40;
    transition: transform 0.3s ease;
  }
  
  #avatarPakBurung.speaking {
    animation: avatarBounce 0.5s ease infinite alternate;
  }
  
  @keyframes avatarBounce {
    from { transform: translateY(0); }
    to { transform: translateY(-5px); }
  }
  
  #messageBox {
    position: absolute;
    bottom: 130px;
    left: 24px;
    width: 300px;
    background: rgba(232, 245, 225, 0.95);
    border: 2px solid var(--primary-light);
    border-radius: 18px;
    padding: 15px 20px;
    font-size: 16px;
    font-weight: 600;
    color: var(--primary-dark);
    text-align: left;
    user-select: none;
    pointer-events: none;
    backdrop-filter: blur(8px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    transform: translateY(20px);
    opacity: 0;
    transition: opacity 0.4s ease, transform 0.4s ease;
    z-index: 40;
    line-height: 1.4;
  }
  
  #messageBox.visible {
    opacity: 1;
    transform: translateY(0);
  }
  
  #healthBarContainer {
    position: absolute;
    left: 50%;
    top: 18px;
    transform: translateX(-50%);
    width: 350px;
    height: 25px;
    background: rgba(255, 255, 255, 0.8);
    border: 2px solid var(--primary);
    border-radius: 30px;
    box-shadow: 0 4px 12px rgba(178, 214, 166, 0.7);
    z-index: 50;
    display: flex;
    align-items: center;
    overflow: hidden;
  }
  
  #healthBar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-light) 60%, #a8e6cf 100%);
    border-radius: 28px;
    transition: width 0.6s cubic-bezier(.2,0,.3,1);
    font-weight: bold;
    color: #226d1b;
    text-align: center;
    font-size: 1rem;
    line-height: 25px;
    min-width: 0;
    position: relative;
    overflow: hidden;
  }
  
  #healthBar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(rgba(255,255,255,0.4), transparent);
  }
  
  #healthBarText {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%);
    font-size: 1rem;
    font-weight: 700;
    color: var(--primary-dark);
    text-shadow: 0 1px 1px rgba(255,255,255,0.8);
    pointer-events: none;
    z-index: 2;
  }
  
  #scoreBoard {
    font-size: 22px;
    font-weight: 700;
    text-align: center;
    margin-top: 14px;
    color: var(--primary);
    text-shadow: 0 1px 2px rgba(255,255,255,0.8);
    background: rgba(255,255,255,0.6);
    border-radius: 15px;
    padding: 4px 16px;
    display: inline-block;
  }
  
  #combo-indicator {
    position: absolute;
    top: 50px;
    right: 30px;
    font-size: 28px;
    font-weight: 800;
    color: var(--accent);
    text-shadow: 0 0 8px rgba(255,255,255,0.7), 0 2px 4px rgba(0,0,0,0.3);
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.3s, transform 0.3s;
    z-index: 100;
  }
  
  #combo-indicator.active {
    opacity: 1;
    transform: scale(1);
    animation: comboAnimation 0.8s ease;
  }
  
  @keyframes comboAnimation {
    0% { transform: scale(0.8); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  
  #timerCircle {
    position: absolute;
    top: 12px;
    right: 16px;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 6px solid var(--primary-light);
    box-shadow: 0 0 10px rgba(122, 196, 122, 0.6) inset,
                0 5px 15px rgba(0,0,0,0.2);
    font-weight: 900;
    color: var(--primary);
    font-family: 'Poppins', sans-serif;
    font-size: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    user-select: none;
    pointer-events: none;
    background: rgba(255, 255, 255, 0.8);
    z-index: 50;
    position: relative;
  }
  
  #timerCircle::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 50%;
    border: 3px solid transparent;
    animation: timerRotate 25s linear forwards;
    border-top-color: var(--primary);
    border-right-color: var(--primary);
  }
  
  @keyframes timerRotate {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  #eduBox {
    max-width: 800px;
    margin: 20px auto 25px;
    background: rgba(232, 245, 225, 0.8);
    border-radius: 16px;
    padding: 16px 25px;
    font-size: 17px;
    font-weight: 600;
    color: var(--primary-dark);
    text-align: center;
    box-shadow: 0 8px 25px rgba(178, 214, 166, 0.6);
    z-index: 40;
    line-height: 1.4;
    transition: transform 0.3s, background-color 0.3s;
  }
  
  #eduBox:hover {
    transform: translateY(-3px);
    background: rgba(232, 245, 225, 0.95);
  }
  
  /* Game Over Overlay */
  #gameOverOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  
  #gameOverContent {
    background: linear-gradient(to bottom right, #f0f8e6, #eaf4d6);
    padding: 40px 50px;
    border-radius: 24px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    max-width: 400px;
    animation: fadeInScale 0.5s;
  }
  
  #gameOverContent h2 {
    margin-bottom: 25px;
    color: var(--primary);
    font-size: 2rem;
  }
  
  #finalStats {
    background: rgba(255,255,255,0.7);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 25px;
    text-align: left;
  }
  
  #finalStats p {
    margin: 10px 0;
    font-size: 1.1rem;
  }
  
  #finalStats .highlight {
    color: var(--primary);
    font-weight: 700;
  }
  
  #treeDeadOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 300;
    width: 100vw;
    height: 100vh;
    overflow: hidden;
  }
  
  #treeDeadContent {
    background: linear-gradient(to bottom right, #fff, #fffbe9);
    padding: 40px 45px;
    border-radius: 24px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    max-width: 380px;
    min-width: 300px;
    display: flex;
    flex-direction: column;
    align-items: center;
    animation: fadeInScale 0.5s;
  }
  
  #treeDeadContent h2 {
    color: var(--danger);
    margin-bottom: 20px;
    font-size: 1.7rem;
    font-weight: 700;
  }
  
  #treeDeadContent p {
    color: #444;
    font-size: 1.1rem;
    margin-bottom: 25px;
    margin-top: 0;
    line-height: 1.5;
  }
  
  #retryBtn {
    background: linear-gradient(to bottom right, var(--primary-light), var(--primary));
    color: #fff;
    font-weight: 700;
    font-size: 18px;
    padding: 14px 38px;
    border-radius: 50px;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 20px rgba(46, 125, 50, 0.5);
    transition: all 0.3s;
    letter-spacing: 0.5px;
    outline: none;
    display: inline-block;
  }
  
  #retryBtn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 25px rgba(46, 125, 50, 0.6);
  }
  
  /* Popup System */
  .popup {
    position: absolute;
    font-size: 24px;
    font-weight: 700;
    pointer-events: none;
    z-index: 100;
    animation: popupAnimation 1.2s ease-out forwards;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  }
  
  @keyframes popupAnimation {
    0% { transform: scale(0.5); opacity: 0; }
    20% { transform: scale(1.2); opacity: 1; }
    80% { transform: translateY(-30px) scale(1); opacity: 1; }
    100% { transform: translateY(-50px) scale(0.8); opacity: 0; }
  }
  
  .popup.success { color: var(--success); }
  .popup.error { color: var(--danger); }
  .popup.warning { color: var(--warning); }
  
  /* Pause Button & Menu */
  #pauseBtn {
    position: absolute;
    top: 15px;
    left: 15px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.8);
    border: none;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    cursor: pointer;
    z-index: 60;
    transition: all 0.3s;
  }
  
  #pauseBtn:hover {
    transform: scale(1.1);
    background: rgba(255,255,255,0.95);
  }
  
  #pauseMenu {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(5px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 250;
  }
  
  #pauseMenuContent {
    background: #fff;
    padding: 30px;
    border-radius: 20px;
    max-width: 350px;
    text-align: center;
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
    animation: fadeInScale 0.4s;
  }
  
  #pauseMenuContent h2 {
    color: var(--primary);
    margin-top: 0;
    margin-bottom: 20px;
  }
  
  .pause-menu-btn {
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 30px;
    margin: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .pause-menu-btn:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
  }
  
  /* Power-up System */
  #powerupContainer {
    position: absolute;
    top: 15px;
    left: 100px;
    display: flex;
    gap: 15px;
    z-index: 60;
  }
  #fadeTransition {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    width: 100vw; height: 100vh;
    background: #eaf6e1;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.7s cubic-bezier(.4,2,.6,1);
  }
  #fadeTransition.active {
    opacity: 1;
    pointer-events: all;
  }
  .powerup {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 24px;
    cursor: pointer;
    position: relative;
    transform: scale(0);
    opacity: 0;
    transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                opacity 0.5s ease;
  }
  
  .powerup.available {
    transform: scale(1);
    opacity: 1;
  }
  
  .powerup:hover {
    transform: scale(1.1);
  }
  
  .powerup::after {
    content: attr(data-tooltip);
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 5px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    margin-top: 5px;
  }
  
  .powerup:hover::after {
    opacity: 1;
  }
  
  /* Animations */
  @keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }
  
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  /* Cursor styles */
  body.cursor-spider { cursor: url('https://api.iconify.design/noto-v1:spider.svg?size=32') 16 16, auto; }
  body.cursor-bird { cursor: url('https://api.iconify.design/noto-v1:bird.svg?size=32') 16 16, auto; }
  body.cursor-stickyTrap { cursor: url('https://api.iconify.design/noto-v1:leaf-fluttering-in-wind.svg?size=32') 16 16, auto; }
  body.cursor-flower { cursor: url('https://api.iconify.design/noto-v1:cherry-blossom.svg?size=32') 16 16, auto; }
  
  /* Responsive Design */
  @media (max-width: 768px) {
    #treeArea { height: 420px; }
    #toolsPanel { gap: 15px; padding: 12px 15px; }
    .tool { width: 60px; height: 60px; font-size: 34px; }
    #avatarPakBurung { width: 90px; height: 90px; font-size: 54px; line-height: 90px; }
    #messageBox { width: 250px; font-size: 15px; }
    #eduBox { max-width: 90%; padding: 12px 16px; font-size: 16px; }
    #gameOverContent, #treeDeadContent { max-width: 90%; padding: 25px; }
    #healthBarContainer { width: 90%; }
    #timerCircle { width: 70px; height: 70px; font-size: 28px; }
  }
  
  @media (max-width: 576px) {
    #treeArea { height: 360px; }
    #toolsPanel { gap: 10px; }
    .tool { width: 50px; height: 50px; font-size: 28px; }
    .tool::after { bottom: -25px; font-size: 12px; }
    #avatarPakBurung { width: 80px; height: 80px; font-size: 48px; line-height: 80px; left: 10px; }
    #messageBox { width: 220px; font-size: 14px; padding: 12px 16px; left: 14px; bottom: 110px; }
    #pauseBtn, .powerup { width: 40px; height: 40px; font-size: 20px; }
    #powerupContainer { left: 70px; }
    h1 { font-size: 1.8rem; }
    #introOverlay h2 { font-size: 2rem; }
    #introOverlay p { font-size: 1.1rem; }
    #timerCircle { width: 60px; height: 60px; font-size: 24px; }
  }
</style>
</head>
<body>
<div id="mainWrapper">

  <!-- Intro Overlay -->
  <div id="introOverlay" class="overlay" role="dialog" aria-modal="true" aria-labelledby="introTitle" aria-describedby="introDesc">
    <h2 id="introTitle">Selamat Datang di Quest Pohon!</h2>
    <p id="introDesc">
      Pohonmu mulai tumbuh, tetapi banyak serangga hama yang mengganggu perkembangannya.<br>
      Gunakan metode alami untuk melindungi pohonmu dan biarkan ia tumbuh dengan sehat!
    </p>
    <button id="showHowToBtn" class="primary-button" aria-label="Lihat Cara Bermain">Baca Cara Bermain</button>
  </div>

  <!-- Cara Bermain Overlay -->
  <div id="howToPlayOverlay" class="overlay">
    <div class="howto-content">
      <h2>Cara Bermain Quest Pohon üå≥</h2>
      <ol>
        <li>Pilih alat pengendalian hama alami di panel bawah: Laba-laba üï∑Ô∏è, Burung üê¶, Perangkap Daun üçÉ, atau Bunga üå∏.</li>
        <li>Setiap hama memiliki alat pengendali yang tepat - perhatikan petunjuk di samping mereka.</li>
        <li>Klik pada serangga hama yang mendekati pohon untuk mengusirnya menggunakan alat yang dipilih.</li>
        <li>Berhati-hatilah! Jangan usir kupu-kupu ü¶ã karena mereka membantu ekosistem.</li>
        <li>Pohonmu akan bertumbuh lebih besar seiring bertambahnya skor.</li>
        <li>Setiap hama yang mencapai pohon akan mengurangi kesehatannya.</li>
        <li>Lindungi pohonmu selama 25 detik untuk menyelesaikan misi!</li>
      </ol>
      <div class="howto-tips">
        <b>Tips untuk sukses:</b>
        <ul>
          <li>Tangkap hama berturut-turut dengan alat yang tepat untuk mendapatkan bonus combo.</li>
          <li>Perhatikan power-up yang muncul selama permainan untuk bantuan ekstra.</li>
          <li>Jika kesehatan pohon mencapai nol, permainan akan berakhir.</li>
        </ul>
      </div>
      <button id="startGameBtn" class="primary-button">Mulai Petualangan</button>
    </div>
  </div>

  <div id="gameContainer" aria-live="polite" aria-atomic="true">
    <div id="header">
      <div id="scoreBoard">Skor: <span id="score">0</span></div>
      <div id="timerCircle" aria-live="assertive" aria-atomic="true">25</div>
    </div>
    
    <!-- Pause button -->
    <button id="pauseBtn" aria-label="Jeda Permainan">‚è∏Ô∏è</button>
    
    <!-- Power-up container -->
    <div id="powerupContainer">
      <div class="powerup" id="slowTime" data-tooltip="Perlambat Waktu (5 detik)">‚è±Ô∏è</div>
      <div class="powerup" id="freezeBugs" data-tooltip="Bekukan Hama (3 detik)">‚ùÑÔ∏è</div>
      <div class="powerup" id="healthBoost" data-tooltip="+20% Kesehatan Pohon">‚ù§Ô∏è</div>
    </div>
    
    <!-- Combo indicator -->
    <div id="combo-indicator">Combo x<span id="combo-count">2</span>!</div>
    
    <div id="treeArea" aria-label="Area pohon dan serangga hama">
      <div id="healthBarContainer">
        <div id="healthBar" style="width:100%"></div>
        <span id="healthBarText">100%</span>
      </div>
      <img id="tree" class="stage-1" src="https://api.iconify.design/noto-v1:deciduous-tree.svg?size=240" alt="Pohon Kecil" />
      <div id="grassElements"></div>
      <div id="bugArea"></div>
      <div id="avatarPakBurung" title="Avatar Pak Burung isyarat">ü¶ú</div>
      <div id="messageBox" role="alert" aria-live="assertive"></div>
    </div>

    <nav id="toolsPanel" aria-label="Alat Pelindung Pohon">
      <button class="tool" data-tool="spider" title="Laba-laba" role="button" tabindex="0" aria-pressed="false">üï∑Ô∏è</button>
      <button class="tool" data-tool="bird" title="Burung Pemakan Serangga" role="button" tabindex="0" aria-pressed="false">üê¶</button>
      <button class="tool" data-tool="stickyTrap" title="Perangkap Daun Lengket" role="button" tabindex="0" aria-pressed="false">üçÉ</button>
      <button class="tool" data-tool="flower" title="Bunga Pengusir Hama" role="button" tabindex="0" aria-pressed="false">üå∏</button>
    </nav>

    <div id="eduBox" aria-live="polite" aria-atomic="true">
      <b>Tips Hari Ini:</b> Pelihara laba-laba di kebunmu karena mereka adalah predator alami bagi banyak hama tanaman.
    </div>
  </div>

  <!-- Pause Menu -->
  <div id="pauseMenu">
    <div id="pauseMenuContent">
      <h2>Permainan Dijeda</h2>
      <p>Kamu bisa melanjutkan permainan atau melihat tutorial kembali.</p>
      <button id="resumeBtn" class="pause-menu-btn">Lanjutkan</button>
      <button id="restartBtn" class="pause-menu-btn">Mulai Ulang</button>
      <button id="howToPlayBtn" class="pause-menu-btn">Lihat Tutorial</button>
    </div>
  </div>

  <!-- Overlay pohon mati -->
  <div id="treeDeadOverlay">
    <div id="treeDeadContent">
      <h2>Pohonmu Tidak Bertahan üò¢</h2>
      <p>Sayang sekali, pohonmu tidak mampu bertahan dari serangan hama yang terlalu banyak. Ingat untuk menggunakan alat yang tepat untuk setiap jenis hama!</p>
      <button id="retryBtn" class="primary-button">Coba Lagi</button>
    </div>
  </div>

  <!-- Game Over Overlay -->
  <div id="gameOverOverlay" role="dialog" aria-modal="true" aria-labelledby="gameOverTitle">
    <div id="gameOverContent">
      <h2 id="gameOverTitle">Misi Berhasil!</h2>
      
      <div id="finalStats">
        <p>Skor Akhir: <span id="finalScoreText" class="highlight">0</span></p>
        <p>Hama Dibasmi: <span id="bugsDefeatedText" class="highlight">0</span></p>
        <p>Combo Terbesar: <span id="maxComboText" class="highlight">0</span></p>
        <p>Kesehatan Pohon: <span id="finalHealthText" class="highlight">0%</span></p>
      </div>
      
      <p id="achievementText" style="font-weight:600;color:var(--primary);margin-bottom:25px;">Penghargaan Diperoleh: Pembela Pohon!</p>
      
      <button id="nextMissionBtn" class="primary-button" aria-label="Lanjut ke Misi Berikutnya">Lanjut ke Misi Berikutnya</button>
    <div id="fadeTransition"></div>

    </div>
  </div>
</div>

<div id="fadeTransition"></div>

<script>
(() => {
  // --- DATA & VARIABEL ---
  const GAME_DURATION = 40;
  const INITIAL_BUG_SPAWN_INTERVAL = 1600;  // Increased from 2200 for slower spawn rate
  const MIN_BUG_SPAWN_INTERVAL = 1000;      // Increased from 800 for slower minimum spawn rate
  const TREE_STAGES = 4;
  const TREE_GROWTH_SCORE = 30;
  const TREE_MAX_HEALTH = 100;
  const TREE_HIT_DAMAGE = 20;
  const COMBO_THRESHOLD = 2;  // Number of consecutive successful catches for combo
  const COMBO_BONUS = 5;      // Extra points for each catch in combo
  const EDUCATIONAL_TIPS = [
    "Burung pemakan serangga mampu mengurangi populasi hama hingga 50% di beberapa pertanian.",
    "Tanaman pendamping seperti bunga marigold dapat mengusir beberapa jenis hama secara alami.",
    "Perangkap lengket organik lebih ramah lingkungan daripada pestisida kimia.",
    "Menjaga keseimbangan ekosistem membantu mengendalikan hama secara alami.",
    "Kupu-kupu dan lebah berperan penting dalam penyerbukan tanaman dan harus dilindungi.",
    "Pengendalian hama terintegrasi menggabungkan berbagai metode alami untuk hasil optimal.",
    "Rotasi tanaman dapat memutus siklus hidup hama dan mengurangi serangan.",
  ];
  
  const BUGS_DATA = [
    {
      id:'ulat', emoji:'üêõ', isHama:true,
      goodTool:['spider','bird'],
      badTool:['pesticide','plasticNet'],
      description: 'Ulat pemakan daun',
      naturalControl: 'Laba-laba üï∑Ô∏è atau Burung üê¶',
      speed: 6000,  // Speed increased (longer duration = slower movement)
      points: 10
    },
    {
      id:'belalang', emoji:'ü¶ó', isHama:true,
      goodTool:['stickyTrap','flower'],
      badTool:['plasticNet','pesticide'],
      description: 'Belalang pemakan tanaman',
      naturalControl: 'Daun lengket üçÉ atau Bunga üå∏',
      speed: 5500,  // Speed increased
      points: 15
    },
    {
      id:'wereng', emoji:'ü™±', isHama:true,
      goodTool:['spider','bird'],
      badTool:['pesticide'],
      description: 'Wereng penghisap getah',
      naturalControl: 'Laba-laba üï∑Ô∏è atau Burung üê¶',
      speed: 5200,  // Speed increased
      points: 20
    },
    {
      id:'kupu', emoji:'ü¶ã', isHama:false,
      goodTool:[],
      badTool:['chase','spray'],
      description: 'Kupu-kupu penyerbuk',
      naturalControl: 'Biarkan mereka bebas ü¶ã',
      speed: 7000,  // Speed increased
      points: 0
    },
    {
      id:'kumbang', emoji:'üêû', isHama:false,
      goodTool:[],
      badTool:['chase','spray'],
      description: 'Kumbang pemangsa hama',
      naturalControl: 'Biarkan membantu pohon üêû',
      speed: 6500,  // Speed increased
      points: 0
    },
    {
      id:'semut', emoji:'üêú', isHama:true,
      goodTool:['stickyTrap','flower'],
      badTool:['pesticide'],
      description: 'Semut perusak batang',
      naturalControl: 'Daun lengket üçÉ atau Bunga üå∏',
      speed: 5000,  // Speed increased
      points: 15
    }
  ];

  // DOM Elements
  const startBtn = document.getElementById('startBtn');
  const scoreEl = document.getElementById('score');
  const timerCircle = document.getElementById('timerCircle');
  const bugArea = document.getElementById('bugArea');
  const tree = document.getElementById('tree');
  const messageBox = document.getElementById('messageBox');
  const avatarPakBurung = document.getElementById('avatarPakBurung');
  const toolsPanel = document.getElementById('toolsPanel');
  const eduBox = document.getElementById('eduBox');
  const gameOverOverlay = document.getElementById('gameOverOverlay');
  const finalScoreText = document.getElementById('finalScoreText');
  const bugsDefeatedText = document.getElementById('bugsDefeatedText');
  const maxComboText = document.getElementById('maxComboText');
  const finalHealthText = document.getElementById('finalHealthText');
  const achievementText = document.getElementById('achievementText');
  const nextMissionBtn = document.getElementById('nextMissionBtn');
  const introOverlay = document.getElementById('introOverlay');
  const showHowToBtn = document.getElementById('showHowToBtn');
  const howToPlayOverlay = document.getElementById('howToPlayOverlay');
  const startGameBtn = document.getElementById('startGameBtn');
  const gameContainer = document.getElementById('gameContainer');
  const healthBar = document.getElementById('healthBar');
  const healthBarText = document.getElementById('healthBarText');
  const treeDeadOverlay = document.getElementById('treeDeadOverlay');
  const retryBtn = document.getElementById('retryBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const pauseMenu = document.getElementById('pauseMenu');
  const resumeBtn = document.getElementById('resumeBtn');
  const restartBtn = document.getElementById('restartBtn');
  const howToPlayBtn = document.getElementById('howToPlayBtn');
  const comboIndicator = document.getElementById('combo-indicator');
  const comboCount = document.getElementById('combo-count');
  const powerups = {
    slowTime: document.getElementById('slowTime'),
    freezeBugs: document.getElementById('freezeBugs'),
    healthBoost: document.getElementById('healthBoost')
  };

  // Game state variables
  let gameTimer = null;
  let spawnTimer = null;
  let timeLeft = GAME_DURATION;
  let score = 0;
  let treeStage = 1;
  let bugsOnScreen = [];
  let gameRunning = false;
  let gamePaused = false;
  let selectedTool = null;
  let treeHealth = TREE_MAX_HEALTH;
  let currentBugSpawnInterval = INITIAL_BUG_SPAWN_INTERVAL;
  let consecutiveSuccess = 0;
  let maxCombo = 0;
  let difficultyFactor = 1.0;
  let bugsDefeated = 0;
  let currentTip = 0;
  let powerupStatus = {
    slowTimeAvailable: false,
    freezeBugsAvailable: false,
    healthBoostAvailable: false,
    bugsSlowed: false,
    bugsFrozen: false
  };

  // Map tool name to cursor css classes
  const toolCursorClasses = {
    spider: 'cursor-spider',
    bird: 'cursor-bird',
    stickyTrap: 'cursor-stickyTrap',
    flower: 'cursor-flower'
  };

  // --- Overlay Logic ---
  introOverlay.style.display = 'flex';
  howToPlayOverlay.style.display = 'none';
  gameContainer.classList.remove('active');
  pauseMenu.style.display = 'none';
  
  for (let key in powerups) {
    powerups[key].classList.remove('available');
  }

  // --- UTILITAS ---
  function capitalize(text) {
    return text.charAt(0).toUpperCase() + text.slice(1);
  }
  
  function updateTimerDisplay() {
    timerCircle.textContent = timeLeft;
    
    if (timeLeft <= 5) {
      timerCircle.style.color = '#b71c1c';
      timerCircle.style.borderColor = '#f44336';
      timerCircle.style.animation = 'pulse 0.5s infinite alternate';
    } else if (timeLeft <= 10) {
      timerCircle.style.color = '#ef6c00';
      timerCircle.style.borderColor = '#ff9800';
      timerCircle.style.animation = 'none';
    } else {
      timerCircle.style.color = 'var(--primary)';
      timerCircle.style.borderColor = 'var(--primary-light)';
      timerCircle.style.animation = 'none';
    }
  }
  
  function updateScoreDisplay() {
    scoreEl.textContent = score;
    
    // Check for tree growth based on score
    let newStage = Math.min(1 + Math.floor(score / TREE_GROWTH_SCORE), TREE_STAGES);
    if (newStage !== treeStage) {
      treeStage = newStage;
      updateTreeStage();
      
      // Show growing animation
      tree.style.filter = 'drop-shadow(0 4px 5px rgba(0,0,0,0.2)) brightness(1.3)';
      setTimeout(() => {
        tree.style.filter = 'drop-shadow(0 4px 5px rgba(0,0,0,0.2))';
      }, 500);
      
      // Show popup
      showPopup(tree.offsetLeft + tree.offsetWidth/2, tree.offsetTop + tree.offsetHeight/2, 
                "Pohon tumbuh! üåø", "success");
      
      // Update tips based on tree stage
      showNextTip();
    }
    
    // Increase difficulty as score increases
    difficultyFactor = 1.0 + (score / 100);
    updateSpawnInterval();
    
    // Give power-ups based on score milestones
    if (score >= 30 && !powerupStatus.slowTimeAvailable) {
      powerupStatus.slowTimeAvailable = true;
      powerups.slowTime.classList.add('available');
      showMessage("Power-up Perlambat Waktu tersedia! ‚è±Ô∏è", 3000);
    }
    
    if (score >= 60 && !powerupStatus.freezeBugsAvailable) {
      powerupStatus.freezeBugsAvailable = true;
      powerups.freezeBugs.classList.add('available');
      showMessage("Power-up Bekukan Hama tersedia! ‚ùÑÔ∏è", 3000);
    }
    
    if (score >= 100 && !powerupStatus.healthBoostAvailable) {
      powerupStatus.healthBoostAvailable = true;
      powerups.healthBoost.classList.add('available');
      showMessage("Power-up Boost Kesehatan tersedia! ‚ù§Ô∏è", 3000);
    }
  }
  
  function updateSpawnInterval() {
    // Gradually decrease spawn interval as game progresses
    currentBugSpawnInterval = Math.max(
      MIN_BUG_SPAWN_INTERVAL,
      INITIAL_BUG_SPAWN_INTERVAL - (timeLeft * 40) - (score * 2)
    );
    
    // If bugs are currently slowed, adjust accordingly
    if (powerupStatus.bugsSlowed) {
      currentBugSpawnInterval *= 2;
    }
    
    // Restart spawn timer with new interval
    if (spawnTimer) {
      clearInterval(spawnTimer);
      if (gameRunning && !gamePaused) {
        spawnTimer = setInterval(spawnBug, currentBugSpawnInterval);
      }
    }
  }
  
  function updateTreeStage() {
    tree.className = 'stage-' + treeStage;
    tree.alt = {
      1: 'Pohon kecil',
      2: 'Pohon bertunas',
      3: 'Pohon sedang tumbuh',
      4: 'Pohon dewasa kuat'
    }[treeStage];
  }
  
  function showMessage(text, duration=4000) {
    messageBox.textContent = text;
    messageBox.classList.add('visible');
    
    if(duration > 0){
      setTimeout(() => {
        messageBox.classList.remove('visible');
        setTimeout(() => {
          messageBox.textContent = '';
        }, 400);
      }, duration);
    }
  }
  
  function pakBurungSay(text, duration=5000) {
    showMessage("Pak Burung: " + text, duration);
    avatarPakBurung.classList.add('speaking');
    
    setTimeout(() => {
      avatarPakBurung.classList.remove('speaking');
    }, 1000);
  }
  
  function removeBug(bugElem) {
    let idx = bugsOnScreen.indexOf(bugElem);
    if(idx !== -1) bugsOnScreen.splice(idx, 1);
    if (bugElem.parentNode) bugElem.parentNode.removeChild(bugElem);
  }
  
  function updateHealthBar() {
    healthBar.style.width = treeHealth + "%";
    healthBarText.textContent = treeHealth + "%";
    
    if (treeHealth > 60) {
      healthBar.style.background = "linear-gradient(90deg, var(--primary-light) 60%, #a8e6cf 100%)";
      healthBarText.style.color = "var(--primary-dark)";
    } else if (treeHealth > 30) {
      healthBar.style.background = "linear-gradient(90deg, var(--warning) 60%, #ffe082 100%)";
      healthBarText.style.color = "#806000";
    } else {
      healthBar.style.background = "linear-gradient(90deg, var(--danger) 60%, #ffcdd2 100%)";
      healthBarText.style.color = "#7f0000";
      
      // Critical health animation
      if (treeHealth <= 20) {
        healthBar.style.animation = "pulse 0.8s infinite alternate";
      }
    }
  }
  
  function decreaseHealth(amount) {
    // Add screen shake effect for damage
    gameContainer.style.animation = "shake 0.3s";
    setTimeout(() => {
      gameContainer.style.animation = "";
    }, 300);
    
    treeHealth -= amount;
    if (treeHealth < 0) treeHealth = 0;
    updateHealthBar();
    
    if (treeHealth <= 0) {
      treeDies();
    }
  }
  
  function increaseHealth(amount) {
    treeHealth = Math.min(treeHealth + amount, TREE_MAX_HEALTH);
    updateHealthBar();
    
    // Show healing animation
    healthBar.style.filter = "brightness(1.3)";
    setTimeout(() => {
      healthBar.style.filter = "none";
    }, 500);
    
    showPopup(healthBarContainer.offsetLeft + healthBarContainer.offsetWidth/2, 
              healthBarContainer.offsetTop, "+" + amount + "% ‚ù§Ô∏è", "success");
  }
  
  function resetHealth() {
    treeHealth = TREE_MAX_HEALTH;
    updateHealthBar();
    healthBar.style.animation = "none";
  }
  
  function treeDies() {
    gameRunning = false;
    clearInterval(gameTimer);
    clearInterval(spawnTimer);
    resetSelectedTool();
    messageBox.classList.remove('visible');
    treeDeadOverlay.style.display = 'flex';
    
    // Show final tree state
    tree.style.filter = "grayscale(1) brightness(0.7)";
    tree.style.transform = "translateX(-50%) rotate(5deg)";
    
    // Stop all bug animations
    bugsOnScreen.forEach(bug => {
      bug.style.animationPlayState = 'paused';
    });
  }
  
  function bugReachedPohon(bugElem, bugData) {
    if (bugElem.dataset.killed === 'true' || gamePaused) return;
    
    if (bugData.isHama) {
      pakBurungSay(`Oh tidak! ${bugData.emoji} ${bugData.description} menyerang pohon!`);
      score = Math.max(0, score - 5);
      updateScoreDisplay();
      
      // Reset combo
      consecutiveSuccess = 0;
      comboIndicator.classList.remove('active');
      
      // Damage tree
      decreaseHealth(TREE_HIT_DAMAGE);
      
      // Show damage popup
      showPopup(tree.offsetLeft + tree.offsetWidth/2, 
                tree.offsetTop + tree.offsetHeight/2, 
                "-" + TREE_HIT_DAMAGE + "% ‚ù§Ô∏è", "error");
                
      // Weaken tree if it gets hit too much
      if (treeHealth < 50 && treeStage > 1) {
        weakenTree();
      }
    } else {
      pakBurungSay(`${bugData.emoji} ${bugData.description} membantu pohonmu tumbuh!`);
      increaseHealth(5);
      addScore(5);
    }
  }
  
  function weakenTree() {
    if (treeStage > 1) {
      treeStage--;
      updateTreeStage();
      showPopup(tree.offsetLeft + tree.offsetWidth/2, 
                tree.offsetTop + tree.offsetHeight/2, 
                "Pohon melemah! üòü", "error");
    }
  }
  
  function resetSelectedTool() {
    selectedTool = null;
    document.body.classList.remove(...Object.values(toolCursorClasses));
    toolsPanel.querySelectorAll('.tool').forEach(t => {
      t.classList.remove('active');
      t.setAttribute('aria-pressed', 'false');
    });
  }
  
  function selectTool(tool) {
    if (selectedTool === tool) {
      resetSelectedTool();
    } else {
      selectedTool = tool;
      document.body.classList.remove(...Object.values(toolCursorClasses));
      let cursorClass = toolCursorClasses[tool];
      if(cursorClass) document.body.classList.add(cursorClass);
      
      toolsPanel.querySelectorAll('.tool').forEach(t => {
        if (t.dataset.tool === tool) {
          t.classList.add('active');
          t.setAttribute('aria-pressed', 'true');
        }
        else {
          t.classList.remove('active');
          t.setAttribute('aria-pressed', 'false');
        }
      });
      
      pakBurungSay(`Alat dipilih: ${toolToName(tool)}`);
    }
  }
  
  function toolToName(tool) {
    return {
      spider: 'Laba-laba',
      bird: 'Burung pemakan serangga',
      stickyTrap: 'Perangkap daun lengket',
      flower: 'Bunga pengusir hama',
      pesticide: 'Pestisida kimia',
      plasticNet: 'Jaring plastik',
      chase: 'Mengusir',
      spray: 'Menyemprot'
    }[tool] || tool;
  }
  
  function addScore(amount) {
    score += amount;
    if (score < 0) score = 0;
    updateScoreDisplay();
  }
  
  function showCatchAnimation(bugElem, bugData, success=true) {
    bugElem.style.transition = 'transform 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.5s ease';
    
    if (success) {
      // Success animation
      bugElem.style.transform = 'scale(0) rotate(180deg)';
      bugElem.style.opacity = '0';
      
      // Particle effect for success
      createParticles(
        bugElem.offsetLeft + bugElem.offsetWidth/2, 
        bugElem.offsetTop + bugElem.offsetHeight/2,
        success ? '#4caf50' : '#f44336'
      );
    } else {
      // Error animation
      bugElem.style.transform = 'scale(0.5) rotate(45deg)';
      bugElem.style.opacity = '0.3';
    }
  }
  
  function createParticles(x, y, color) {
    for (let i = 0; i < 8; i++) {
      const particle = document.createElement('div');
      particle.style.position = 'absolute';
      particle.style.left = x + 'px';
      particle.style.top = y + 'px';
      particle.style.width = '8px';
      particle.style.height = '8px';
      particle.style.borderRadius = '50%';
      particle.style.backgroundColor = color;
      particle.style.zIndex = '100';
      particle.style.pointerEvents = 'none';
      
      const angle = Math.random() * Math.PI * 2;
      const speed = 2 + Math.random() * 3;
      const opacity = 0.7 + Math.random() * 0.3;
      
      particle.style.opacity = opacity;
      
      document.body.appendChild(particle);
      
      // Animate the particle
      let moveX = 0;
      let moveY = 0;
      const animateParticle = () => {
        moveX += Math.cos(angle) * speed;
        moveY += Math.sin(angle) * speed + 0.2; // Add a bit of gravity
        
        particle.style.transform = `translate(${moveX}px, ${moveY}px)`;
        particle.style.opacity = parseFloat(particle.style.opacity) - 0.02;
        
        if (parseFloat(particle.style.opacity) > 0) {
          requestAnimationFrame(animateParticle);
        } else {
          particle.remove();
        }
      };
      
      requestAnimationFrame(animateParticle);
    }
  }
  
  function showPopup(x, y, text, type = 'success') {
    const popup = document.createElement('div');
    popup.className = `popup ${type}`;
    popup.textContent = text;
    popup.style.left = x + 'px';
    popup.style.top = y + 'px';
    document.body.appendChild(popup);
    
    setTimeout(() => {
      popup.remove();
    }, 1200);
  }
  
  function updateCombo(success) {
    if (success) {
      consecutiveSuccess++;
      if (consecutiveSuccess >= COMBO_THRESHOLD) {
        comboCount.textContent = consecutiveSuccess;
        comboIndicator.classList.add('active');
        
        if (consecutiveSuccess > maxCombo) {
          maxCombo = consecutiveSuccess;
        }
      }
    } else {
      consecutiveSuccess = 0;
      comboIndicator.classList.remove('active');
    }
  }
  
  function showNextTip() {
    eduBox.innerHTML = `<b>Tips Alam:</b> ${EDUCATIONAL_TIPS[currentTip]}`;
    currentTip = (currentTip + 1) % EDUCATIONAL_TIPS.length;
  }
  
  function activatePowerup(type) {
    switch(type) {
      case 'slowTime':
        if (!powerupStatus.slowTimeAvailable) return;
        
        powerupStatus.slowTimeAvailable = false;
        powerupStatus.bugsSlowed = true;
        powerups.slowTime.classList.remove('available');
        
        // Slow down all bugs currently on screen
        bugsOnScreen.forEach(bug => {
          bug.classList.add('slow-motion');
        });
        
        showPopup(timerCircle.offsetLeft + timerCircle.offsetWidth/2, 
                  timerCircle.offsetTop + timerCircle.offsetHeight/2,
                  "Waktu Diperlambat!", "success");
        
        // Effect lasts for 5 seconds
        setTimeout(() => {
          powerupStatus.bugsSlowed = false;
          bugsOnScreen.forEach(bug => {
            bug.classList.remove('slow-motion');
          });
          updateSpawnInterval();
        }, 5000);
        break;
        
      case 'freezeBugs':
        if (!powerupStatus.freezeBugsAvailable) return;
        
        powerupStatus.freezeBugsAvailable = false;
        powerupStatus.bugsFrozen = true;
        powerups.freezeBugs.classList.remove('available');
        
        // Freeze all bugs currently on screen
        bugsOnScreen.forEach(bug => {
          const originalTransition = bug.style.transition;
          bug.style.transition = 'none';
          bug.dataset.frozen = 'true';
          
          // Add freeze effect
          bug.style.filter = 'drop-shadow(0 0 5px #42a5f5) brightness(1.2)';
          
          setTimeout(() => {
            bug.style.transition = originalTransition;
          }, 50);
        });
        
        showPopup(gameContainer.offsetWidth / 2, gameContainer.offsetHeight / 2,
                  "Hama Dibekukan!", "success");
        
        // Effect lasts for 3 seconds
        setTimeout(() => {
          powerupStatus.bugsFrozen = false;
          bugsOnScreen.forEach(bug => {
            bug.dataset.frozen = 'false';
            bug.style.filter = '';
          });
        }, 3000);
        break;
        
      case 'healthBoost':
        if (!powerupStatus.healthBoostAvailable) return;
        
        powerupStatus.healthBoostAvailable = false;
        powerups.healthBoost.classList.remove('available');
        
        // Boost tree health
        increaseHealth(20);
        showPopup(healthBarContainer.offsetLeft + healthBarContainer.offsetWidth/2, 
                  healthBarContainer.offsetTop,
                  "+20% Kesehatan!", "success");
        break;
    }
  }

  // --- GAME LOGIC ---
  function spawnBug() {
    if (!gameRunning || gamePaused) return;
    
    // Select random bug, with weighting that increases difficult bugs as game progresses
    let selection;
    let weightedSelection = Math.random() * difficultyFactor;
    
    if (weightedSelection > 0.8) {
      // More difficult/faster bugs
      selection = BUGS_DATA.filter(b => b.speed < 4000);
    } else if (weightedSelection > 0.4) {
      // Medium difficulty
      selection = BUGS_DATA.filter(b => b.speed >= 3800);
    } else {
      // Random selection from all bugs
      selection = BUGS_DATA;
    }
    
    // Add beneficial bugs (kupu-kupu & kumbang) periodically
    if (Math.random() < 0.15) {
      selection = BUGS_DATA.filter(b => !b.isHama);
    }
    
    const bugData = selection[Math.floor(Math.random() * selection.length)];
    const bugElem = document.createElement('div');
    bugElem.classList.add('bug');
    bugElem.setAttribute('aria-label', `${bugData.id}, ${bugData.isHama ? 'hama' : 'bukan hama'}`);
    bugElem.dataset.bugId = bugData.id;
    bugElem.dataset.isHama = bugData.isHama;
    bugElem.dataset.killed = 'false';
    bugElem.dataset.frozen = 'false';
    bugElem.style.top = Math.random() < 0.5 ? '-40px' : (Math.random() * (bugArea.clientHeight - 100)) + 'px';

    // Random side: true = left side, false = right side
    const fromLeft = Math.random() < 0.5;
    bugElem.style.left = fromLeft ? '-50px' : (bugArea.clientWidth + 50) + 'px';

    bugElem.innerHTML = `<div>${bugData.emoji}</div><div class="bug-label">
      <strong>${capitalize(bugData.id)}</strong><br>
      ${bugData.isHama ? 'Basmi: ' + bugData.naturalControl : 'Bukan hama! Biarkan!'}
    </div>`;

    bugElem.addEventListener('click', function(e) {
      if (!gameRunning || gamePaused) return;
      if (bugElem.dataset.killed === 'true') return;
      if (bugElem.dataset.frozen === 'true') return;
      
      if (!selectedTool) {
        pakBurungSay('Pilih alat terlebih dahulu untuk mengusir hama!');
        return;
      }
      
      const bugId = bugElem.dataset.bugId;
      const bugDataObj = BUGS_DATA.find(b => b.id === bugId);
      if (!bugDataObj) return;
      
      if (selectedTool === 'pesticide' || selectedTool === 'plasticNet' || 
          selectedTool === 'chase' || selectedTool === 'spray') {
        pakBurungSay('Hindari penggunaan cara kasar! Gunakan pengendalian alami.');
        updateCombo(false);
        return;
      }
      
      if (!bugDataObj.isHama) {
        if (['flower','spider','bird','stickyTrap'].includes(selectedTool)) {
          pakBurungSay(`${bugDataObj.emoji} ${bugDataObj.description} tidak perlu dibasmi!`);
          updateCombo(false);
          return;
        }
      }
      
      if (bugDataObj.goodTool.includes(selectedTool)) {
        pakBurungSay(`Bagus! ${toolToName(selectedTool)} efektif untuk menangani ${bugDataObj.emoji}.`, 3000);
        bugElem.dataset.killed = 'true';
        bugsDefeated++;
        
        // Calculate score with combo bonus if applicable
        let earnedPoints = bugDataObj.points;
        if (consecutiveSuccess >= COMBO_THRESHOLD) {
          earnedPoints += COMBO_BONUS;
        }
        addScore(earnedPoints);
        
        // Show score popup
        showPopup(
          bugElem.offsetLeft + bugElem.offsetWidth/2, 
          bugElem.offsetTop,
          "+" + earnedPoints, "success"
        );
        
        updateCombo(true);
        showCatchAnimation(bugElem, bugDataObj, true);
        setTimeout(() => {
          removeBug(bugElem);
        }, 600);
      } else if (bugDataObj.badTool.includes(selectedTool)) {
        pakBurungSay(`${toolToName(selectedTool)} tidak ramah lingkungan!`);
        addScore(-5);
        updateCombo(false);
        showPopup(
          bugElem.offsetLeft + bugElem.offsetWidth/2, 
          bugElem.offsetTop,
          "-5", "error"
        );
        showCatchAnimation(bugElem, bugDataObj, false);
        setTimeout(() => {
          removeBug(bugElem);
        }, 600);
      } else {
        pakBurungSay(`${toolToName(selectedTool)} kurang efektif untuk ${bugDataObj.emoji}, coba alat lain.`);
        addScore(-3);
        updateCombo(false);
        showPopup(
          bugElem.offsetLeft + bugElem.offsetWidth/2, 
          bugElem.offsetTop,
          "Tidak efektif", "warning"
        );
      }
    });

    bugArea.appendChild(bugElem);
    bugsOnScreen.push(bugElem);

    animateBugToTree(bugElem, bugData, fromLeft);
  }

  function animateBugToTree(bugElem, bugData, fromLeft) {
    const treeAreaWidth = bugArea.clientWidth;
    const treeAreaHeight = bugArea.clientHeight;
    let startX = parseFloat(bugElem.style.left);
    let startY = parseFloat(bugElem.style.top);
    let targetX = (treeAreaWidth / 2) - 15;
    let targetY = treeAreaHeight - 80; // Adjusted to be above ground
    
    // Variasi jalur (noise) untuk bug yang berbeda
    targetX += (Math.random() - 0.5) * 100;
    
    // For non-pests, make them move in a more wandering path
    if (!bugData.isHama) {
      targetX = startX + (Math.random() * 400 - 200);
      targetY = startY + (Math.random() * 300);
      
      if (targetX < 0) targetX = 50;
      if (targetX > treeAreaWidth) targetX = treeAreaWidth - 50;
      if (targetY < 0) targetY = 50;
      if (targetY > treeAreaHeight - 120) targetY = treeAreaHeight - 120; // Keep above ground
    }
    
    // Speed varies by bug type
    let duration = powerupStatus.bugsSlowed ? bugData.speed * 2 : bugData.speed;
    
    // Control points for bezier curve motion
    const cp1x = startX + (targetX - startX) * 0.3 + (Math.random() - 0.5) * 150;
    const cp1y = startY + (targetY - startY) * 0.1 + (Math.random() - 0.5) * 100;
    const cp2x = startX + (targetX - startX) * 0.7 + (Math.random() - 0.5) * 150;
    const cp2y = startY + (targetY - startY) * 0.9 + (Math.random() - 0.5) * 100;
    
    let startTime = null;

    function animate(time) {
      if (!gameRunning) return;
      if (gamePaused) {
        requestAnimationFrame(animate);
        return;
      }
      
      if (bugElem.dataset.frozen === 'true') {
        requestAnimationFrame(animate);
        return;
      }
      
      if (!startTime) startTime = time;
      let elapsed = time - startTime;
      let progress = Math.min(elapsed / duration, 1);
      
      // Cubic bezier calculation for smoother, more natural movement
      function calculateBezierPoint(t, p0, p1, p2, p3) {
        const cX = 3 * (p1 - p0);
        const bX = 3 * (p2 - p1) - cX;
        const aX = p3 - p0 - cX - bX;
        
        return aX * Math.pow(t, 3) + bX * Math.pow(t, 2) + cX * t + p0;
      }
      
      let currentX = calculateBezierPoint(progress, startX, cp1x, cp2x, targetX);
      let currentY = calculateBezierPoint(progress, startY, cp1y, cp2y, targetY);
      
      bugElem.style.left = currentX + 'px';
      bugElem.style.top = currentY + 'px';
      
      // No rotation animation as requested
      // Just add a small vertical movement for butterflies/non-pests
      if (!bugData.isHama) {
        bugElem.style.transform = `translateY(${Math.sin(progress * 20) * 5}px)`;
      }
      
      if (progress < 1 && bugElem.dataset.killed !== 'true') {
        requestAnimationFrame(animate);
      } else if (progress >= 1 && bugElem.dataset.killed !== 'true') {
        bugReachedPohon(bugElem, bugData);
        removeBug(bugElem);
      }
    }
    
    requestAnimationFrame(animate);
  }

  function startGame() {
    if (gameRunning) return;
    
    // Initialize game state
    gameRunning = true;
    gamePaused = false;
    score = 0;
    timeLeft = GAME_DURATION;
    treeStage = 1;
    consecutiveSuccess = 0;
    maxCombo = 0;
    bugsDefeated = 0;
    difficultyFactor = 1.0;
    currentBugSpawnInterval = INITIAL_BUG_SPAWN_INTERVAL;
    currentTip = 0;
    
    // Reset power-ups
    powerupStatus = {
      slowTimeAvailable: false,
      freezeBugsAvailable: false,
      healthBoostAvailable: false,
      bugsSlowed: false,
      bugsFrozen: false
    };
    
    for (let key in powerups) {
      powerups[key].classList.remove('available');
    }
    
    // Reset UI
    resetHealth();
    updateTreeStage();
    updateScoreDisplay();
    updateTimerDisplay();
    messageBox.classList.remove('visible');
    comboIndicator.classList.remove('active');
    
    // Clear any bugs from previous game
    bugsOnScreen.forEach(bug => {
      if (bug.parentNode) bug.parentNode.removeChild(bug);
    });
    bugsOnScreen = [];
    
    // Reset visuals
    tree.style.filter = '';
    tree.style.transform = 'translateX(-50%)';
    
    // Hide overlays
    gameOverOverlay.style.display = 'none';
    treeDeadOverlay.style.display = 'none';
    pauseMenu.style.display = 'none';
    introOverlay.style.display = 'none';
    howToPlayOverlay.style.display = 'none';
    
    // Show game container
    gameContainer.classList.add('active');
    
    // Reset tool selection
    resetSelectedTool();
    
    // Show initial tip
    showNextTip();
    
    // Start timers
    gameTimer = setInterval(() => {
      if (gamePaused) return;
      
      timeLeft--;
      updateTimerDisplay();
      
      // Show next tip every 8 seconds
      if (timeLeft % 8 === 0) {
        showNextTip();
      }
      
      if (timeLeft <= 0) {
        endGame();
      }
    }, 1000);
    
    spawnTimer = setInterval(spawnBug, currentBugSpawnInterval);
    
    // Initial welcome message
    pakBurungSay("Lindungi pohon dari hama! Pilih alat yang tepat untuk setiap jenis hama.");
  }

  function pauseGame() {
    if (!gameRunning || gamePaused) return;
    
    gamePaused = true;
    pauseMenu.style.display = 'flex';
    
    // Pause all animations
    bugsOnScreen.forEach(bug => {
      bug.style.animationPlayState = 'paused';
    });
    
    clearInterval(gameTimer);
    clearInterval(spawnTimer);
  }
  
  function resumeGame() {
    if (!gameRunning || !gamePaused) return;
    
    gamePaused = false;
    pauseMenu.style.display = 'none';
    
    // Resume all animations
    bugsOnScreen.forEach(bug => {
      bug.style.animationPlayState = 'running';
    });
    
    // Restart timers
    gameTimer = setInterval(() => {
      if (gamePaused) return;
      
      timeLeft--;
      updateTimerDisplay();
      
      if (timeLeft % 8 === 0) {
        showNextTip();
      }
      
      if (timeLeft <= 0) {
        endGame();
      }
    }, 1000);
    
    spawnTimer = setInterval(spawnBug, currentBugSpawnInterval);
  }

  function endGame() {
    gameRunning = false;
    clearInterval(gameTimer);
    clearInterval(spawnTimer);
    resetSelectedTool();
    messageBox.classList.remove('visible');
    
    // Set final stats
    finalScoreText.textContent = score;
    bugsDefeatedText.textContent = bugsDefeated;
    maxComboText.textContent = maxCombo;
    finalHealthText.textContent = treeHealth + "%";
    
    // Determine achievement level
    let achievement = "Penjaga Pohon";
    if (score >= 150) achievement = "Pelindung Pohon Legendaris";
    else if (score >= 100) achievement = "Pakar Pengendalian Hama";
    else if (score >= 50) achievement = "Sahabat Lingkungan";
    
    achievementText.textContent = "Penghargaan: " + achievement + "!";
    
    // Show game over overlay
    gameOverOverlay.style.display = 'flex';
    
    // Show a celebratory message
    pakBurungSay(`Misi selesai! Kamu berhasil melindungi pohon dengan baik!`);
    
    // Final tree animation
    if (treeHealth > 50) {
      tree.style.filter = 'drop-shadow(0 8px 12px rgba(0,0,0,0.3)) brightness(1.1)';
      createParticles(
        tree.offsetLeft + tree.offsetWidth/2, 
        tree.offsetTop + tree.offsetHeight/2,
        '#4caf50'
      );
    }
  }

  // --- EVENT LISTENERS ---
  toolsPanel.querySelectorAll('.tool').forEach(toolElem => {
    toolElem.addEventListener('click', () => {
      if (!gameRunning || gamePaused) return;
      selectTool(toolElem.dataset.tool);
    });
    
    toolElem.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (!gameRunning || gamePaused) return;
        selectTool(toolElem.dataset.tool);
      }
    });
  });
  
  // Power-up listeners
  for (let key in powerups) {
    powerups[key].addEventListener('click', () => {
      if (!gameRunning || gamePaused) return;
      activatePowerup(key);
    });
  }
  
  // Pause button
  pauseBtn.addEventListener('click', () => {
    if (gamePaused) {
      resumeGame();
    } else {
      pauseGame();
    }
  });
  
  // Pause menu buttons
  resumeBtn.addEventListener('click', resumeGame);
  restartBtn.addEventListener('click', startGame);
  howToPlayBtn.addEventListener('click', () => {
    pauseMenu.style.display = 'none';
    howToPlayOverlay.style.display = 'flex';
  });
  
  // Overlay buttons
  showHowToBtn.addEventListener('click', function() {
    introOverlay.style.display = 'none';
    howToPlayOverlay.style.display = 'flex';
  });
  
  startGameBtn.addEventListener('click', function() {
    howToPlayOverlay.style.display = 'none';
    startGame();
  });
  
  nextMissionBtn.addEventListener('click', () => {
    fadeTransition.classList.add('active');
    setTimeout(() => {
      window.location.href = 'game-tunarunguOceanMission.html';
    }, 700);
  });

  retryBtn.addEventListener('click', () => {
    treeDeadOverlay.style.display = 'none';
    startGame();
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (!gameRunning) return;
    
    switch(e.key) {
      case 'p':
      case 'P':
        if (gamePaused) resumeGame();
        else pauseGame();
        break;
      case '1':
        selectTool('spider');
        break;
      case '2':
        selectTool('bird');
        break;
      case '3':
        selectTool('stickyTrap');
        break;
      case '4':
        selectTool('flower');
        break;
      case 'Escape':
        if (gamePaused) resumeGame();
        else pauseGame();
        break;
    }
  });

  // Prevent scroll on mobile
  window.addEventListener('touchmove', function(e) {
    if (gameRunning) e.preventDefault();
  }, { passive: false });
  
  // Animation for pause button
  pauseBtn.addEventListener('mouseenter', () => {
    pauseBtn.style.transform = 'scale(1.1)';
  });
  
  pauseBtn.addEventListener('mouseleave', () => {
    pauseBtn.style.transform = 'scale(1)';
  });
  
  // Add CSS animation for critical effects
  const style = document.createElement('style');
  style.textContent = `
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }
  `;
  document.head.appendChild(style);

  // --- FADING TRANSITION LOGIC ---
  const fadeTransition = document.getElementById('fadeTransition');
  // Pastikan elemen sudah ada
  if (fadeTransition) {
    // Fade out saat halaman selesai dimuat
    window.addEventListener('DOMContentLoaded', () => {
      fadeTransition.classList.add('active');
      setTimeout(() => {
        fadeTransition.classList.remove('active');
      }, 700);
    });
  }

  // Fade in saat klik next mission
  nextMissionBtn.addEventListener('click', () => {
    if (fadeTransition) {
      fadeTransition.classList.add('active');
      setTimeout(() => {
        window.location.href = 'game-tunarunguOceanMission.html';
      }, 700);
    } else {
      window.location.href = 'game-tunarunguOceanMission.html';
    }
  });
})();
</script>
</body>
</html>